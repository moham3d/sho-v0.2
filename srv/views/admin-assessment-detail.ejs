<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assessment Details - Al-Shorouk Radiology Management System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/css/custom.css" rel="stylesheet">
</head>
<body>
    <!-- Navigation -->
    <%- include('navigation', { currentPage: 'admin' }) %>

    <div class="container mt-4" id="main-content" role="main">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <!-- Breadcrumbs -->
                <nav aria-label="breadcrumb" class="mb-3">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item">
                            <a href="/"><i class="fas fa-home me-1" aria-hidden="true"></i>Home</a>
                        </li>
                        <li class="breadcrumb-item">
                            <a href="/admin">Admin</a>
                        </li>
                        <li class="breadcrumb-item">
                            <a href="/admin/assessments">Assessment Management</a>
                        </li>
                        <li class="breadcrumb-item active" aria-current="page">Assessment Details</li>
                    </ol>
                </nav>

                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h2>
                            <i class="fas fa-<%= assessment.assessment_type === 'nursing' ? 'user-nurse' : 'x-ray' %> me-2" aria-hidden="true"></i>
                            <%= assessment.assessment_type.charAt(0).toUpperCase() + assessment.assessment_type.slice(1) %> Assessment Details
                        </h2>
                        <p class="text-muted">Assessment ID: <%= assessment.assessment_type === 'nursing' ? assessment.assessment_id : assessment.radiology_id %></p>
                    </div>
                    <div class="d-flex gap-2">
                        <a href="/admin/assessments" class="btn btn-outline-secondary btn-custom">
                            <i class="fas fa-arrow-left me-2" aria-hidden="true"></i>Back to Assessments
                        </a>
                        <button type="button" class="btn btn-outline-danger btn-custom"
                                data-assessment-id="<%= assessment.assessment_type === 'nursing' ? assessment.assessment_id : assessment.radiology_id %>"
                                data-assessment-type="<%= assessment.assessment_type %>"
                                data-patient-name="<%= assessment.patient_name %>"
                                onclick="confirmDeleteAssessment(this)">
                            <i class="fas fa-trash me-2" aria-hidden="true"></i>Delete Assessment
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notification -->
        <% if (notification) { %>
            <div class="alert alert-<%= notification.type === 'success' ? 'success' : 'danger' %> alert-dismissible fade show" role="alert">
                <i class="fas fa-<%= notification.type === 'success' ? 'check-circle' : 'exclamation-triangle' %> me-2" aria-hidden="true"></i>
                <%= notification.message %>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        <% } %>

        <!-- Assessment Type and Status -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body text-center">
                        <h5>Assessment Type</h5>
                        <% if (assessment.assessment_type === 'nursing') { %>
                            <span class="badge assessment-type-nursing fs-6">
                                <i class="fas fa-user-nurse fa-2x me-2" aria-hidden="true"></i>Nursing Assessment
                            </span>
                        <% } else { %>
                            <span class="badge assessment-type-radiology fs-6">
                                <i class="fas fa-x-ray fa-2x me-2" aria-hidden="true"></i>Radiology Assessment
                            </span>
                        <% } %>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body text-center">
                        <h5>Status</h5>
                        <% if (assessment.submission_status === 'submitted') { %>
                            <span class="badge status-submitted fs-6">
                                <i class="fas fa-check-circle fa-2x me-2" aria-hidden="true"></i>Submitted
                            </span>
                        <% } else { %>
                            <span class="badge status-draft fs-6">
                                <i class="fas fa-edit fa-2x me-2" aria-hidden="true"></i>Draft
                            </span>
                        <% } %>
                    </div>
                </div>
            </div>
        </div>

        <!-- Patient Information -->
        <div class="patient-info">
            <h5><i class="fas fa-user me-2" aria-hidden="true"></i>Patient Information</h5>
            <div class="row">
                <div class="col-md-3">
                    <span class="detail-label">Full Name:</span>
                    <span class="detail-value"><%= assessment.patient_name %></span>
                </div>
                <div class="col-md-3">
                    <span class="detail-label">Medical Number:</span>
                    <span class="detail-value"><%= assessment.medical_number || 'Not provided' %></span>
                </div>
                <div class="col-md-3">
                    <span class="detail-label">Mobile:</span>
                    <span class="detail-value"><%= assessment.mobile_number || 'Not provided' %></span>
                </div>
                <div class="col-md-3">
                    <span class="detail-label">Date of Birth:</span>
                    <span class="detail-value">
                        <%= assessment.date_of_birth ? new Date(assessment.date_of_birth).toLocaleDateString() : 'Not provided' %>
                    </span>
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-md-3">
                    <span class="detail-label">Gender:</span>
                    <span class="detail-value"><%= assessment.gender || 'Not specified' %></span>
                </div>
                <div class="col-md-9">
                    <span class="detail-label">Address:</span>
                    <span class="detail-value"><%= assessment.address || 'Not provided' %></span>
                </div>
            </div>
        </div>

        <!-- Visit Information -->
        <div class="visit-info">
            <h5><i class="fas fa-calendar-check me-2" aria-hidden="true"></i>Visit Information</h5>
            <div class="row">
                <div class="col-md-3">
                    <span class="detail-label">Visit ID:</span>
                    <span class="detail-value"><%= assessment.visit_id %></span>
                </div>
                <div class="col-md-3">
                    <span class="detail-label">Visit Date:</span>
                    <span class="detail-value"><%= new Date(assessment.visit_date).toLocaleDateString() %></span>
                </div>
                <div class="col-md-3">
                    <span class="detail-label">Visit Status:</span>
                    <span class="detail-value"><%= assessment.visit_status %></span>
                </div>
                <div class="col-md-3">
                    <span class="detail-label">Assessed By:</span>
                    <span class="detail-value"><%= assessment.assessed_by_name || 'Unknown' %></span>
                </div>
            </div>
        </div>

        <!-- Assessment Details -->
        <% if (assessment.assessment_type === 'nursing') { %>
            <!-- Nursing Assessment Details -->
            <div class="card mb-4">
                <div class="card-header">
                    <h4 class="section-title">
                        <i class="fas fa-user-nurse me-2" aria-hidden="true"></i>Nursing Assessment Details
                    </h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="detail-row">
                                <span class="detail-label">Mode of Arrival:</span>
                                <span class="detail-value"><%= assessment.mode_of_arrival || 'Not specified' %></span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Age:</span>
                                <span class="detail-value"><%= assessment.age || 'Not specified' %></span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Chief Complaint:</span>
                                <span class="detail-value"><%= assessment.chief_complaint || 'Not specified' %></span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Accompanied By:</span>
                                <span class="detail-value"><%= assessment.accompanied_by || 'Not specified' %></span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Language Spoken:</span>
                                <span class="detail-value"><%= assessment.language_spoken || 'Not specified' %></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="detail-row">
                                <span class="detail-label">Temperature:</span>
                                <span class="detail-value"><%= assessment.temperature_celsius ? assessment.temperature_celsius + ' Â°C' : 'Not measured' %></span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Pulse:</span>
                                <span class="detail-value"><%= assessment.pulse_bpm ? assessment.pulse_bpm + ' bpm' : 'Not measured' %></span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Blood Pressure:</span>
                                <span class="detail-value">
                                    <%= assessment.blood_pressure_systolic && assessment.blood_pressure_diastolic ?
                                        assessment.blood_pressure_systolic + '/' + assessment.blood_pressure_diastolic + ' mmHg' :
                                        'Not measured' %>
                                </span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Respiratory Rate:</span>
                                <span class="detail-value"><%= assessment.respiratory_rate_per_min ? assessment.respiratory_rate_per_min + '/min' : 'Not measured' %></span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Oxygen Saturation:</span>
                                <span class="detail-value"><%= assessment.oxygen_saturation_percent ? assessment.oxygen_saturation_percent + '%' : 'Not measured' %></span>
                            </div>
                        </div>
                    </div>

                    <!-- Additional sections for nursing assessment -->
                    <hr>
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Vital Signs & Measurements</h6>
                            <div class="detail-row">
                                <span class="detail-label">Blood Sugar:</span>
                                <span class="detail-value"><%= assessment.blood_sugar_mg_dl ? assessment.blood_sugar_mg_dl + ' mg/dL' : 'Not measured' %></span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Weight:</span>
                                <span class="detail-value"><%= assessment.weight_kg ? assessment.weight_kg + ' kg' : 'Not measured' %></span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Height:</span>
                                <span class="detail-value"><%= assessment.height_cm ? assessment.height_cm + ' cm' : 'Not measured' %></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>Patient Condition</h6>
                            <div class="detail-row">
                                <span class="detail-label">Psychological Problem:</span>
                                <span class="detail-value"><%= assessment.psychological_problem || 'Not specified' %></span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Smoker:</span>
                                <span class="detail-value"><%= assessment.is_smoker ? 'Yes' : 'No' %></span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Allergies:</span>
                                <span class="detail-value"><%= assessment.has_allergies ? 'Yes' : 'No' %></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        <% } else { %>
            <!-- Radiology Assessment Details -->
            <div class="card mb-4">
                <div class="card-header">
                    <h4 class="section-title">
                        <i class="fas fa-x-ray me-2" aria-hidden="true"></i>Radiology Assessment Details
                    </h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="detail-row">
                                <span class="detail-label">Treating Physician:</span>
                                <span class="detail-value"><%= assessment.treating_physician || 'Not specified' %></span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Department:</span>
                                <span class="detail-value"><%= assessment.department || 'Not specified' %></span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Fasting Hours:</span>
                                <span class="detail-value"><%= assessment.fasting_hours || 'Not specified' %></span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Diabetic:</span>
                                <span class="detail-value"><%= assessment.is_diabetic ? 'Yes' : 'No' %></span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Blood Sugar Level:</span>
                                <span class="detail-value"><%= assessment.blood_sugar_level || 'Not measured' %></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="detail-row">
                                <span class="detail-label">Weight:</span>
                                <span class="detail-value"><%= assessment.weight_kg ? assessment.weight_kg + ' kg' : 'Not measured' %></span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Height:</span>
                                <span class="detail-value"><%= assessment.height_cm ? assessment.height_cm + ' cm' : 'Not measured' %></span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Dose Amount:</span>
                                <span class="detail-value"><%= assessment.dose_amount || 'Not specified' %></span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">CTDIvol:</span>
                                <span class="detail-value"><%= assessment.ctd1vol || 'Not specified' %></span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">DLP:</span>
                                <span class="detail-value"><%= assessment.dlp || 'Not specified' %></span>
                            </div>
                        </div>
                    </div>

                    <hr>
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Medical History</h6>
                            <div class="detail-row">
                                <span class="detail-label">First Time:</span>
                                <span class="detail-value"><%= assessment.is_first_time ? 'Yes' : 'No' %></span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Uses Contrast:</span>
                                <span class="detail-value"><%= assessment.uses_contrast ? 'Yes' : 'No' %></span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Kidney Function:</span>
                                <span class="detail-value"><%= assessment.kidney_function_value || 'Not specified' %></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>Assessment Results</h6>
                            <div class="detail-row">
                                <span class="detail-label">Diagnosis:</span>
                                <span class="detail-value"><%= assessment.diagnosis || 'Not specified' %></span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Reason for Study:</span>
                                <span class="detail-value"><%= assessment.reason_for_study || 'Not specified' %></span>
                            </div>
                        </div>
                    </div>

                    <% if (assessment.findings || assessment.impression || assessment.recommendations) { %>
                        <hr>
                        <div class="row">
                            <div class="col-12">
                                <h6>Radiology Report</h6>
                                <% if (assessment.findings) { %>
                                    <div class="detail-row">
                                        <span class="detail-label">Findings:</span>
                                        <span class="detail-value"><%= assessment.findings %></span>
                                    </div>
                                <% } %>
                                <% if (assessment.impression) { %>
                                    <div class="detail-row">
                                        <span class="detail-label">Impression:</span>
                                        <span class="detail-value"><%= assessment.impression %></span>
                                    </div>
                                <% } %>
                                <% if (assessment.recommendations) { %>
                                    <div class="detail-row">
                                        <span class="detail-label">Recommendations:</span>
                                        <span class="detail-value"><%= assessment.recommendations %></span>
                                    </div>
                                <% } %>
                            </div>
                        </div>
                    <% } %>
                </div>
            </div>
        <% } %>

        <!-- Signature Section -->
        <% if ((assessment.assessment_type === 'nursing' && assessment.nurse_signature) || (assessment.assessment_type === 'radiology' && assessment.physician_signature)) { %>
            <div class="card">
                <div class="card-body">
                    <div class="signature-section">
                        <h5>
                            <i class="fas fa-signature me-2" aria-hidden="true"></i>
                            <%= assessment.assessment_type === 'nursing' ? 'Nurse' : 'Physician' %> Signature
                        </h5>
                        <img src="<%= assessment.assessment_type === 'nursing' ? assessment.nurse_signature : assessment.physician_signature %>"
                             alt="<%= assessment.assessment_type === 'nursing' ? 'Nurse' : 'Physician' %> Signature"
                             class="signature-image">
                        <p class="text-muted mt-2">
                            Signed by <%= assessment.assessed_by_name || 'Unknown' %> on <%= new Date(assessment.assessed_at).toLocaleString() %>
                        </p>
                    </div>
                </div>
            </div>
        <% } %>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Delete Assessment Confirmation Modal -->
    <div class="modal fade" id="deleteAssessmentModal" tabindex="-1" aria-labelledby="deleteAssessmentModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h3 class="modal-title" id="deleteAssessmentModalLabel">
                        <i class="fas fa-exclamation-triangle me-2" aria-hidden="true"></i>Confirm Assessment Deletion
                    </h3>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-danger">
                        <i class="fas fa-warning me-2" aria-hidden="true"></i>
                        <strong>Warning:</strong> This action cannot be undone!
                    </div>
                    <p>Are you sure you want to delete this <strong id="assessmentTypeText"></strong> assessment for <strong id="assessmentPatientName"></strong>?</p>
                    <ul class="text-muted">
                        <li>The assessment record will be permanently removed</li>
                        <li>All associated form data will be deleted</li>
                        <li>This action affects medical records and cannot be reversed</li>
                    </ul>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2" aria-hidden="true"></i>Cancel
                    </button>
                    <form id="deleteAssessmentForm" method="POST" class="d-inline">
                        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                        <button type="submit" class="btn btn-danger">
                            <i class="fas fa-trash me-2" aria-hidden="true"></i>Yes, Delete Assessment
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Handle delete assessment modal
        function confirmDeleteAssessment(button) {
            const assessmentId = button.getAttribute('data-assessment-id');
            const assessmentType = button.getAttribute('data-assessment-type');
            const patientName = button.getAttribute('data-patient-name');

            document.getElementById('assessmentTypeText').textContent = assessmentType.charAt(0).toUpperCase() + assessmentType.slice(1);
            document.getElementById('assessmentPatientName').textContent = patientName;
            document.getElementById('deleteAssessmentForm').action = `/admin/assessments/${assessmentId}/delete?type=${assessmentType}`;

            const modal = new bootstrap.Modal(document.getElementById('deleteAssessmentModal'));
            modal.show();
        }
    </script>
</body>
</html>