<!DOCTYPE html>
<html lang="en">

<head>
    <%- include('partials/head', { title: 'Assessment Details' }) %>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
</head>

<body class="admin-compact">
    <div class="d-flex vh-100 bg-light overflow-hidden">
        <!-- Sidebar -->
        <%- include('partials/admin-sidebar', { currentPage: 'assessments' }) %>

            <!-- Main Content -->
            <div class="flex-grow-1 d-flex flex-column h-100 overflow-hidden">
                <!-- Header -->
                <%- include('partials/admin-header', { title: 'Assessment Details' }) %>

                    <!-- Scrollable Content -->
                    <main class="flex-grow-1 overflow-auto p-4">

                        <% if (notification) { %>
                            <div class="alert alert-<%= notification.type === 'error' ? 'danger' : 'success' %> alert-dismissible fade show mb-4 border-0 shadow-sm"
                                role="alert">
                                <% if(notification.type==='success' ) { %><i class="bi bi-check-circle-fill me-2"></i>
                                    <% } %>
                                        <% if(notification.type==='error' ) { %><i
                                                class="bi bi-exclamation-triangle-fill me-2"></i>
                                            <% } %>
                                                <%= notification.message %>
                                                    <button type="button" class="btn-close" data-bs-dismiss="alert"
                                                        aria-label="Close"></button>
                            </div>
                            <% } %>

                                <!-- Page Header & Actions -->
                                <div class="d-flex justify-content-between align-items-center mb-4">
                                    <div>
                                        <nav aria-label="breadcrumb">
                                            <ol class="breadcrumb mb-1">
                                                <li class="breadcrumb-item"><a href="/admin/visits"
                                                        class="text-decoration-none text-muted">Visits</a></li>
                                                <li class="breadcrumb-item active" aria-current="page">Assessment</li>
                                            </ol>
                                        </nav>
                                        <h4 class="fw-bold mb-0">
                                            <% if (assessment.assessment_type==='nursing' ) { %>
                                                <i class="bi bi-activity me-2 text-primary"></i>Nursing Assessment
                                                <% } else { %>
                                                    <i class="bi bi-radioactive me-2 text-success"></i>Radiology
                                                    Assessment
                                                    <% } %>
                                        </h4>
                                    </div>
                                    <div class="d-flex gap-2">
                                        <a href="/admin/visits/<%= assessment.visit_id %>" class="btn btn-light border">
                                            <i class="bi bi-arrow-left me-2"></i>Back to Visit
                                        </a>
                                        <button type="button" class="btn btn-outline-danger"
                                            data-assessment-id="<%= assessment.assessment_type === 'nursing' ? assessment.assessment_id : assessment.radiology_id %>"
                                            data-assessment-type="<%= assessment.assessment_type %>"
                                            data-patient-name="<%= assessment.patient_name %>"
                                            onclick="confirmDeleteAssessment(this)">
                                            <i class="bi bi-trash me-2"></i>Delete
                                        </button>
                                    </div>
                                </div>

                                <div class="row g-4">
                                    <!-- Left Column: Patient & Meta Info -->
                                    <div class="col-lg-4">
                                        <div class="card border-0 shadow-sm rounded-3 mb-4">
                                            <div class="card-header bg-white border-bottom-0 py-3">
                                                <h5 class="mb-0 fw-bold"><i
                                                        class="bi bi-person me-2 text-primary"></i>Patient Info</h5>
                                            </div>
                                            <div class="card-body pt-0">
                                                <div class="d-flex align-items-center mb-3">
                                                    <div class="avatar-circle bg-primary-subtle text-primary rounded-circle d-flex align-items-center justify-content-center me-3"
                                                        style="width: 48px; height: 48px; font-size: 1.25rem; font-weight: bold;">
                                                        <%= (assessment.patient_name || 'U' ).charAt(0).toUpperCase() %>
                                                    </div>
                                                    <div>
                                                        <h6 class="mb-0 fw-bold">
                                                            <%= assessment.patient_name %>
                                                        </h6>
                                                        <small class="text-muted">
                                                            <%= assessment.medical_number || 'No Med ID' %>
                                                        </small>
                                                    </div>
                                                </div>
                                                <hr class="text-muted opacity-25">
                                                <dl class="row g-0 mb-0">
                                                    <dt class="col-sm-4 text-muted small fw-normal">DOB</dt>
                                                    <dd class="col-sm-8 small fw-medium">
                                                        <%= assessment.date_of_birth ? new
                                                            Date(assessment.date_of_birth).toLocaleDateString() : '-' %>
                                                    </dd>

                                                    <dt class="col-sm-4 text-muted small fw-normal">Gender</dt>
                                                    <dd class="col-sm-8 small fw-medium">
                                                        <%= assessment.gender || '-' %>
                                                    </dd>

                                                    <dt class="col-sm-4 text-muted small fw-normal">Phone</dt>
                                                    <dd class="col-sm-8 small fw-medium">
                                                        <%= assessment.mobile_number || '-' %>
                                                    </dd>
                                                </dl>
                                            </div>
                                        </div>

                                        <div class="card border-0 shadow-sm rounded-3">
                                            <div class="card-header bg-white border-bottom-0 py-3">
                                                <h5 class="mb-0 fw-bold"><i
                                                        class="bi bi-info-circle me-2 text-primary"></i>Metadata</h5>
                                            </div>
                                            <div class="card-body pt-0">
                                                <dl class="row g-0 mb-0">
                                                    <dt class="col-sm-5 text-muted small fw-normal">Visit ID</dt>
                                                    <dd class="col-sm-7 small fw-medium text-truncate"
                                                        title="<%= assessment.visit_id %>">
                                                        <%= assessment.visit_id %>
                                                    </dd>

                                                    <dt class="col-sm-5 text-muted small fw-normal">Date</dt>
                                                    <dd class="col-sm-7 small fw-medium">
                                                        <%= new Date(assessment.assessed_at ||
                                                            assessment.created_at).toLocaleDateString() %>
                                                    </dd>

                                                    <dt class="col-sm-5 text-muted small fw-normal">Assessor</dt>
                                                    <dd class="col-sm-7 small fw-medium">
                                                        <%= assessment.assessed_by_name || 'Unknown' %>
                                                    </dd>

                                                    <dt class="col-sm-5 text-muted small fw-normal">Status</dt>
                                                    <dd class="col-sm-7 small">
                                                        <% if (assessment.submission_status==='submitted' ) { %>
                                                            <span
                                                                class="badge bg-success-subtle text-success border border-success-subtle rounded-pill">Submitted</span>
                                                            <% } else { %>
                                                                <span
                                                                    class="badge bg-warning-subtle text-warning border border-warning-subtle rounded-pill">Draft</span>
                                                                <% } %>
                                                    </dd>
                                                </dl>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Right Column: Assessment Details -->
                                    <div class="col-lg-8">
                                        <div class="card border-0 shadow-sm rounded-3">
                                            <div class="card-header bg-white border-bottom-0 py-3">
                                                <h5 class="mb-0 fw-bold">Detailed Report</h5>
                                            </div>
                                            <div class="card-body pt-0">
                                                <% if (assessment.assessment_type==='nursing' ) { %>

                                                    <div class="row row-cols-2 row-cols-md-3 row-cols-lg-6 g-2 mb-4">
                                                        <div class="col">
                                                            <div class="p-2 border rounded text-center bg-light h-100">
                                                                <small class="d-block text-muted text-uppercase"
                                                                    style="font-size: 0.65rem;">Temp</small>
                                                                <div class="fw-bold text-dark">
                                                                    <%= assessment.temperature_celsius || '-' %> <span
                                                                            class="small text-muted fw-normal">Â°C</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="col">
                                                            <div class="p-2 border rounded text-center bg-light h-100">
                                                                <small class="d-block text-muted text-uppercase"
                                                                    style="font-size: 0.65rem;">Pulse</small>
                                                                <div class="fw-bold text-dark">
                                                                    <%= assessment.pulse_bpm || '-' %> <span
                                                                            class="small text-muted fw-normal">bpm</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="col">
                                                            <div class="p-2 border rounded text-center bg-light h-100">
                                                                <small class="d-block text-muted text-uppercase"
                                                                    style="font-size: 0.65rem;">BP</small>
                                                                <div class="fw-bold text-dark">
                                                                    <%= assessment.blood_pressure_systolic || '-' %>/<%=
                                                                            assessment.blood_pressure_diastolic || '-'
                                                                            %>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="col">
                                                            <div class="p-2 border rounded text-center bg-light h-100">
                                                                <small class="d-block text-muted text-uppercase"
                                                                    style="font-size: 0.65rem;">Resp</small>
                                                                <div class="fw-bold text-dark">
                                                                    <%= assessment.respiratory_rate_per_min || '-' %>
                                                                        <span
                                                                            class="small text-muted fw-normal">/min</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="col">
                                                            <div class="p-2 border rounded text-center bg-light h-100">
                                                                <small class="d-block text-muted text-uppercase"
                                                                    style="font-size: 0.65rem;">SpO2</small>
                                                                <div class="fw-bold text-dark">
                                                                    <%= assessment.oxygen_saturation_percent || '-' %>
                                                                        <span
                                                                            class="small text-muted fw-normal">%</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="col">
                                                            <div class="p-2 border rounded text-center bg-light h-100">
                                                                <small class="d-block text-muted text-uppercase"
                                                                    style="font-size: 0.65rem;">Sugar</small>
                                                                <div class="fw-bold text-dark">
                                                                    <%= assessment.blood_sugar_mg_dl || '-' %> <span
                                                                            class="small text-muted fw-normal">mg/dL</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <h6
                                                        class="text-uppercase text-secondary small fw-bold mb-3 border-bottom pb-2">
                                                        Physical Condition</h6>
                                                    <div class="row g-3 mb-4">
                                                        <div class="col-md-6">
                                                            <dl class="row mb-0">
                                                                <dt class="col-6 text-muted small fw-normal">Mode of
                                                                    Arrival</dt>
                                                                <dd class="col-6 small fw-medium">
                                                                    <%= assessment.mode_of_arrival || 'N/A' %>
                                                                </dd>
                                                                <dt class="col-6 text-muted small fw-normal">
                                                                    Consciousness</dt>
                                                                <dd class="col-6 small fw-medium">
                                                                    <%= assessment.consciousness_level || 'N/A' %>
                                                                </dd>
                                                                <dt class="col-6 text-muted small fw-normal">Mobility
                                                                </dt>
                                                                <dd class="col-6 small fw-medium">
                                                                    <%= assessment.mobility_status || 'N/A' %>
                                                                </dd>
                                                            </dl>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <dl class="row mb-0">
                                                                <dt class="col-6 text-muted small fw-normal">Smoker</dt>
                                                                <dd class="col-6 small fw-medium">
                                                                    <%= assessment.is_smoker ? 'Yes' : 'No' %>
                                                                </dd>
                                                                <dt class="col-6 text-muted small fw-normal">Allergies
                                                                </dt>
                                                                <dd class="col-6 small fw-medium">
                                                                    <%= assessment.has_allergies ? 'Yes' : 'No' %>
                                                                </dd>
                                                                <dt class="col-6 text-muted small fw-normal">Diet Type
                                                                </dt>
                                                                <dd class="col-6 small fw-medium">
                                                                    <%= assessment.diet_type || 'N/A' %>
                                                                </dd>
                                                            </dl>
                                                        </div>
                                                    </div>

                                                    <% if (assessment.chief_complaint) { %>
                                                        <div class="mb-3">
                                                            <h6
                                                                class="text-uppercase text-secondary small fw-bold mb-2">
                                                                Chief Complaint</h6>
                                                            <div class="p-3 bg-light rounded small text-dark">
                                                                <%= assessment.chief_complaint %>
                                                            </div>
                                                        </div>
                                                        <% } %>

                                                            <% } else { %>

                                                                <div class="row g-3 mb-4">
                                                                    <div class="col-md-6">
                                                                        <dl class="row mb-0">
                                                                            <dt
                                                                                class="col-6 text-muted small fw-normal">
                                                                                Department</dt>
                                                                            <dd class="col-6 small fw-medium">
                                                                                <%= assessment.department || 'N/A' %>
                                                                            </dd>
                                                                            <dt
                                                                                class="col-6 text-muted small fw-normal">
                                                                                Modality</dt>
                                                                            <dd class="col-6 small fw-medium">
                                                                                <%= assessment.modality || 'N/A' %>
                                                                            </dd>
                                                                            <dt
                                                                                class="col-6 text-muted small fw-normal">
                                                                                Contrast</dt>
                                                                            <dd class="col-6 small fw-medium">
                                                                                <%= assessment.uses_contrast ? 'Yes'
                                                                                    : 'No' %>
                                                                            </dd>
                                                                        </dl>
                                                                    </div>
                                                                    <div class="col-md-6">
                                                                        <dl class="row mb-0">
                                                                            <dt
                                                                                class="col-6 text-muted small fw-normal">
                                                                                Dose Amount</dt>
                                                                            <dd class="col-6 small fw-medium">
                                                                                <%= assessment.dose_amount || 'N/A' %>
                                                                            </dd>
                                                                            <dt
                                                                                class="col-6 text-muted small fw-normal">
                                                                                CTDIvol</dt>
                                                                            <dd class="col-6 small fw-medium">
                                                                                <%= assessment.ctd1vol || 'N/A' %>
                                                                            </dd>
                                                                            <dt
                                                                                class="col-6 text-muted small fw-normal">
                                                                                DLP</dt>
                                                                            <dd class="col-6 small fw-medium">
                                                                                <%= assessment.dlp || 'N/A' %>
                                                                            </dd>
                                                                        </dl>
                                                                    </div>
                                                                </div>

                                                                <% if (assessment.reason_for_study) { %>
                                                                    <div class="mb-4">
                                                                        <h6
                                                                            class="text-uppercase text-secondary small fw-bold mb-2">
                                                                            Reason for Study</h6>
                                                                        <div
                                                                            class="p-3 bg-light rounded small text-dark">
                                                                            <%= assessment.reason_for_study %>
                                                                        </div>
                                                                    </div>
                                                                    <% } %>

                                                                        <% if (assessment.findings) { %>
                                                                            <div class="mb-4">
                                                                                <h6
                                                                                    class="text-uppercase text-secondary small fw-bold mb-2">
                                                                                    Findings</h6>
                                                                                <div class="p-3 border rounded bg-white small text-dark"
                                                                                    style="white-space: pre-wrap;">
                                                                                    <%= assessment.findings %>
                                                                                </div>
                                                                            </div>
                                                                            <% } %>

                                                                                <% if (assessment.impression) { %>
                                                                                    <div class="mb-4">
                                                                                        <h6
                                                                                            class="text-uppercase text-secondary small fw-bold mb-2">
                                                                                            Impression</h6>
                                                                                        <div class="p-3 border rounded bg-white small text-dark"
                                                                                            style="white-space: pre-wrap;">
                                                                                            <%= assessment.impression %>
                                                                                        </div>
                                                                                    </div>
                                                                                    <% } %>

                                                                                        <% if
                                                                                            (assessment.recommendations)
                                                                                            { %>
                                                                                            <div class="mb-4">
                                                                                                <h6
                                                                                                    class="text-uppercase text-secondary small fw-bold mb-2">
                                                                                                    Recommendations</h6>
                                                                                                <div class="p-3 border rounded bg-warning-subtle text-dark border-warning small"
                                                                                                    style="white-space: pre-wrap;">
                                                                                                    <%= assessment.recommendations
                                                                                                        %>
                                                                                                </div>
                                                                                            </div>
                                                                                            <% } %>

                                                                                                <% } %>

                                                                                                    <!-- Signature -->
                                                                                                    <% if
                                                                                                        (assessment.nurse_signature
                                                                                                        ||
                                                                                                        assessment.physician_signature)
                                                                                                        { %>
                                                                                                        <div
                                                                                                            class="mt-4 pt-4 border-top">
                                                                                                            <h6
                                                                                                                class="text-uppercase text-secondary small fw-bold mb-3">
                                                                                                                Signature
                                                                                                            </h6>
                                                                                                            <div
                                                                                                                class="p-3 border rounded bg-white d-inline-block">
                                                                                                                <img src="<%= assessment.nurse_signature || assessment.physician_signature %>"
                                                                                                                    alt="Signature"
                                                                                                                    style="height: 60px;">
                                                                                                            </div>
                                                                                                            <div
                                                                                                                class="small text-muted mt-2">
                                                                                                                Signed
                                                                                                                by <%=
                                                                                                                    assessment.assessed_by_name
                                                                                                                    || 'Unknown'
                                                                                                                    %>
                                                                                                            </div>
                                                                                                        </div>
                                                                                                        <% } %>

                                            </div>
                                        </div>
                                    </div>
                                </div>

                    </main>
            </div>
    </div>

    <%- include('partials/scripts') %>

        <!-- Delete Assessment Confirmation Modal -->
        <div class="modal fade" id="deleteAssessmentModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content border-0 shadow">
                    <div class="modal-header bg-danger text-white border-0">
                        <h5 class="modal-title fw-bold">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>Delete Assessment
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                            aria-label="Close"></button>
                    </div>
                    <div class="modal-body p-4">
                        <p class="mb-3">Are you sure you want to delete this <strong id="assessmentTypeText"></strong>
                            assessment for <strong id="assessmentPatientName"></strong>?</p>
                        <div class="alert alert-danger bg-danger-subtle border-danger-subtle text-danger mb-0">
                            <i class="bi bi-exclamation-circle me-2"></i>This action cannot be undone.
                        </div>
                    </div>
                    <div class="modal-footer border-0 pt-0">
                        <button type="button" class="btn btn-light border" data-bs-dismiss="modal">Cancel</button>
                        <form id="deleteAssessmentForm" method="POST">
                            <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                            <button type="submit" class="btn btn-danger">Delete Permanently</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <script>
            function confirmDeleteAssessment(button) {
                const assessmentId = button.getAttribute('data-assessment-id');
                const assessmentType = button.getAttribute('data-assessment-type');
                const patientName = button.getAttribute('data-patient-name');

                document.getElementById('assessmentTypeText').textContent = assessmentType.charAt(0).toUpperCase() + assessmentType.slice(1);
                document.getElementById('assessmentPatientName').textContent = patientName;
                document.getElementById('deleteAssessmentForm').action = `/admin/assessments/${assessmentId}/delete?type=${assessmentType}`;

                const modal = new bootstrap.Modal(document.getElementById('deleteAssessmentModal'));
                modal.show();
            }
        </script>
</body>

</html>