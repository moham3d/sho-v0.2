<!DOCTYPE html>
<html lang="en">

<head>
    <%- include('partials/head', { title: 'Admin Dashboard' }) %>

        <style>
            .stat-card {
                transition: transform 0.2s, box-shadow 0.2s;
            }

            .stat-card:hover {
                transform: translateY(-5px);
                box-shadow: 0 .5rem 1rem rgba(0, 0, 0, .15) !important;
            }

            .icon-box {
                width: 48px;
                height: 48px;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 12px;
            }
        </style>
</head>

<body class="admin-compact">
    <div class="d-flex vh-100 bg-light overflow-hidden">
        <!-- Sidebar -->
        <%- include('partials/admin-sidebar', { currentPage: 'dashboard' }) %>

            <!-- Main Content -->
            <div class="flex-grow-1 d-flex flex-column h-100 overflow-hidden">
                <!-- Header -->
                <%- include('partials/admin-header', { title: 'Overview' }) %>

                    <!-- Scrollable Content -->
                    <main class="flex-grow-1 overflow-auto p-4">

                        <!-- Reports & Actions Row -->
                        <div class="row g-4 mb-4">
                            <div class="col-md-6">
                                <div class="card border-0 shadow-sm h-100">
                                    <div class="card-header bg-primary text-white border-0 py-3">
                                        <h5 class="mb-0 fw-bold"><i class="bi bi-file-earmark-spreadsheet me-2"></i>Data
                                            Export</h5>
                                    </div>
                                    <div class="card-body">
                                        <p class="text-muted mb-4">Export system data to CSV format for external
                                            analysis or reporting.</p>
                                        <div class="d-grid gap-3">
                                            <a href="/admin/export/patients"
                                                class="btn btn-outline-primary text-start p-3 d-flex align-items-center">
                                                <div class="bg-primary-subtle text-primary rounded p-2 me-3">
                                                    <i class="bi bi-people-fill fs-4"></i>
                                                </div>
                                                <div>
                                                    <div class="fw-bold">Export Patients</div>
                                                    <div class="small text-muted">Download full patient registry</div>
                                                </div>
                                                <i class="bi bi-download ms-auto"></i>
                                            </a>
                                            <a href="/admin/export/visits"
                                                class="btn btn-outline-success text-start p-3 d-flex align-items-center">
                                                <div class="bg-success-subtle text-success rounded p-2 me-3">
                                                    <i class="bi bi-calendar-check fs-4"></i>
                                                </div>
                                                <div>
                                                    <div class="fw-bold">Export Visits</div>
                                                    <div class="small text-muted">Download all visit records</div>
                                                </div>
                                                <i class="bi bi-download ms-auto"></i>
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="card border-0 shadow-sm h-100">
                                    <div class="card-header bg-success text-white border-0 py-3">
                                        <h5 class="mb-0 fw-bold"><i class="bi bi-printer me-2"></i>Quick
                                            Actions</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="row g-3">
                                            <div class="col-6">
                                                <div class="p-3 border rounded bg-light text-center h-100">
                                                    <h3 class="fw-bold text-dark mb-1">
                                                        <%= stats.visits %>
                                                    </h3>
                                                    <small class="text-muted d-block mb-3">Total Visits</small>
                                                    <a href="/admin/visits" class="btn btn-sm btn-dark w-100">Manage
                                                        Visits</a>
                                                </div>
                                            </div>
                                            <div class="col-6">
                                                <div class="p-3 border rounded bg-light text-center h-100">
                                                    <h3 class="fw-bold text-dark mb-1">
                                                        <%= stats.today_visits %>
                                                    </h3>
                                                    <small class="text-muted d-block mb-3">Today's Visits</small>
                                                    <a href="/admin/visits?date=today"
                                                        class="btn btn-sm btn-dark w-100">View Today</a>
                                                </div>
                                            </div>
                                            <div class="col-12"> <!-- Full width stats block -->
                                                <div class="d-flex align-items-center p-3 border rounded bg-light">
                                                    <div class="flex-grow-1">
                                                        <h6 class="mb-1 fw-bold">Pending Assessments</h6>
                                                        <div class="progress" style="height: 6px;">
                                                            <div class="progress-bar bg-warning" role="progressbar"
                                                                style="width: <%= (stats.assessments > 0 ? ((stats.assessments - stats.today_completed) / stats.assessments * 100) : 0) %>%">
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="ms-3 text-end">
                                                        <h4 class="mb-0 fw-bold">
                                                            <%= stats.assessments - stats.today_completed %>
                                                        </h4>
                                                        <a href="/admin/assessments?status=draft"
                                                            class="small text-decoration-none">View Pending</a>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Recent Activity & Users -->
                        <div class="row g-4">
                            <div class="col-lg-8">
                                <div class="card border-0 shadow-sm h-100">
                                    <div class="card-header bg-dark text-white border-0 py-3">
                                        <h6 class="mb-0 fw-bold"><i class="bi bi-search me-2"></i>Search Completed
                                            Reports</h6>
                                    </div>
                                    <div class="card-body">
                                        <!-- Search Form -->
                                        <form action="/admin" method="GET" class="mb-4">
                                            <div class="input-group">
                                                <input type="text" name="report_search" class="form-control"
                                                    placeholder="Search by SSN, Medical Number, or Visit ID..."
                                                    value="<%= typeof searchQuery !== 'undefined' ? searchQuery : '' %>">
                                                <button class="btn btn-primary" type="submit">Search</button>
                                                <% if (typeof searchQuery !=='undefined' && searchQuery) { %>
                                                    <a href="/admin" class="btn btn-outline-secondary">Clear</a>
                                                    <% } %>
                                            </div>
                                        </form>

                                        <!-- Results List -->
                                        <% if (typeof searchResults !=='undefined' && searchResults.length> 0) { %>
                                            <div class="list-group list-group-flush border rounded">
                                                <% searchResults.forEach(item=> { %>
                                                    <div
                                                        class="list-group-item p-3 border-bottom d-flex align-items-center justify-content-between flex-wrap gap-2">
                                                        <div class="d-flex align-items-center">
                                                            <div
                                                                class="avatar-circle bg-primary-subtle text-primary me-3 flex-shrink-0">
                                                                <i class="bi bi-file-text"></i>
                                                            </div>
                                                            <div>
                                                                <h6 class="mb-0 fw-bold text-dark">
                                                                    <%= item.patient_name %>
                                                                </h6>
                                                                <div class="small text-muted mb-1">
                                                                    <span class="me-2"><i
                                                                            class="bi bi-card-text me-1"></i>
                                                                        <%= item.medical_number %>
                                                                    </span>
                                                                    <span><i class="bi bi-upc-scan me-1"></i>
                                                                        <%= item.visit_id %>
                                                                    </span>
                                                                </div>
                                                                <span class="badge bg-light text-dark border">
                                                                    <%= new Date(item.visit_date).toLocaleDateString()
                                                                        %>
                                                                </span>
                                                                <span
                                                                    class="badge bg-secondary-subtle text-secondary ms-1">
                                                                    <%= item.department || 'General' %>
                                                                </span>
                                                            </div>
                                                        </div>
                                                        <div class="ms-md-auto mt-2 mt-md-0">
                                                            <a href="/admin/visits/<%= item.visit_id %>/print"
                                                                target="_blank"
                                                                class="btn btn-outline-dark rounded-pill px-4">
                                                                <i class="bi bi-printer me-2"></i>Print Report
                                                            </a>
                                                        </div>
                                                    </div>
                                                    <% }); %>
                                            </div>
                                            <% } else if (typeof searchQuery !=='undefined' && searchQuery) { %>
                                                <div class="text-center py-5">
                                                    <i class="bi bi-search text-muted display-4 mb-3"></i>
                                                    <h6 class="text-muted">No completed reports found for "<%=
                                                            searchQuery %>"
                                                    </h6>
                                                </div>
                                                <% } else { %>
                                                    <div class="text-center py-5">
                                                        <i class="bi bi-files text-muted display-4 mb-3"></i>
                                                        <h6 class="text-muted">Enter search terms to find and print
                                                            reports</h6>
                                                    </div>
                                                    <% } %>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-4">
                                <div class="card border-0 shadow-sm h-100">
                                    <div
                                        class="card-header bg-dark text-white border-0 py-3 d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0 fw-bold">Recent Users</h6>
                                        <a href="/admin/users" class="btn btn-xs btn-outline-light rounded-pill">View
                                            All</a>
                                    </div>
                                    <div class="card-body p-0">
                                        <div class="list-group list-group-flush">
                                            <% if (users && users.length> 0) { %>
                                                <% users.forEach(u=> { %>
                                                    <div
                                                        class="list-group-item px-4 py-3 border-0 d-flex align-items-center">
                                                        <div class="avatar-circle bg-light text-secondary me-3 small">
                                                            <%= (u.username || 'U' ).charAt(0).toUpperCase() %>
                                                        </div>
                                                        <div class="flex-grow-1">
                                                            <h6 class="mb-0 text-dark small fw-bold">
                                                                <%= u.full_name || u.username %>
                                                            </h6>
                                                            <small class="text-muted text-uppercase"
                                                                style="font-size: 10px;">
                                                                <%= u.role %>
                                                            </small>
                                                        </div>
                                                        <span
                                                            class="badge <%= u.is_active ? 'bg-success-subtle text-success' : 'bg-danger-subtle text-danger' %> rounded-pill"
                                                            style="font-size: 10px;">
                                                            <%= u.is_active ? 'Active' : 'Inactive' %>
                                                        </span>
                                                    </div>
                                                    <% }); %>
                                                        <% } %>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </main>
            </div>
    </div>

    <%- include('partials/scripts') %>

</body>

</html>