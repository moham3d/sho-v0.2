<!DOCTYPE html>
<html lang="en">

<head>
    <%- include('partials/head', { title: 'Assessment Management - Al-Shorouk Radiology Management System' }) %>
</head>

<body class="admin-compact">
    <div class="d-flex vh-100 bg-light overflow-hidden">
        <!-- Sidebar -->
        <%- include('partials/admin-sidebar', { currentPage: 'assessments' }) %>

            <!-- Main Content -->
            <div class="flex-grow-1 d-flex flex-column overflow-hidden">
                <!-- Header -->
                <%- include('partials/admin-header', { title: 'Assessments' }) %>

                    <!-- Scrollable Content -->
                    <div class="flex-grow-1 overflow-auto p-4">
                        <div class="container-fluid">
                            <!-- Page Header -->
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <div>
                                    <h2 class="mb-1">Assessment Management</h2>
                                    <p class="text-muted mb-0">Monitor and manage nursing and radiology assessments</p>
                                </div>
                            </div>

                            <!-- Notification -->
                            <% if (notification) { %>
                                <div class="alert alert-<%= notification.type === 'success' ? 'success' : 'danger' %> alert-dismissible fade show shadow-sm"
                                    role="alert">
                                    <div class="d-flex align-items-center">
                                        <i
                                            class="bi bi-<%= notification.type === 'success' ? 'check-circle-fill' : 'exclamation-triangle-fill' %> me-2 fs-5"></i>
                                        <div>
                                            <%= notification.message %>
                                        </div>
                                    </div>
                                    <button type="button" class="btn-close" data-bs-dismiss="alert"
                                        aria-label="Close"></button>
                                </div>
                                <% } %>

                                    <!-- Search and Filters Card -->
                                    <div class="card border-0 shadow-sm mb-4">
                                        <div class="card-body p-3">
                                            <form method="GET" action="/admin/assessments">
                                                <div class="row g-2 align-items-center">
                                                    <!-- Search Input -->
                                                    <div class="col">
                                                        <div class="input-group">
                                                            <span class="input-group-text bg-light border-end-0"><i
                                                                    class="bi bi-search text-muted"></i></span>
                                                            <input type="text" class="form-control border-start-0 ps-0"
                                                                id="search" name="search"
                                                                value="<%= filters.search || '' %>"
                                                                placeholder="Search Patients, MRN, or Visit ID...">
                                                        </div>
                                                    </div>

                                                    <!-- Filter Toggle -->
                                                    <div class="col-auto">
                                                        <button
                                                            class="btn <%= (filters.type && filters.type !== 'all') || (filters.status && filters.status !== 'all') || filters.date_from || filters.date_to ? 'btn-primary' : 'btn-outline-secondary' %>"
                                                            type="button" data-bs-toggle="collapse"
                                                            data-bs-target="#advancedFilters" aria-expanded="false">
                                                            <i class="bi bi-sliders me-1"></i>Filters
                                                        </button>
                                                    </div>

                                                    <!-- Submit Search -->
                                                    <div class="col-auto">
                                                        <button type="submit" class="btn btn-primary">Search</button>
                                                    </div>
                                                </div>

                                                <!-- Advanced Filters (Collapsible) -->
                                                <div class="collapse mt-3 <%= (filters.type && filters.type !== 'all') || (filters.status && filters.status !== 'all') || filters.date_from || filters.date_to ? 'show' : '' %>"
                                                    id="advancedFilters">
                                                    <div class="bg-light rounded p-3">
                                                        <div class="row g-3">
                                                            <div class="col-6 col-md-3">
                                                                <label for="type"
                                                                    class="form-label small fw-bold text-muted text-uppercase">Type</label>
                                                                <select class="form-select form-select-sm" id="type"
                                                                    name="type">
                                                                    <option value="all" <%=!filters.type ||
                                                                        filters.type==='all' ? 'selected' : '' %>>All
                                                                        Types</option>
                                                                    <option value="nursing" <%=filters.type==='nursing'
                                                                        ? 'selected' : '' %>>Nursing</option>
                                                                    <option value="radiology"
                                                                        <%=filters.type==='radiology' ? 'selected' : ''
                                                                        %>>Radiology</option>
                                                                </select>
                                                            </div>
                                                            <div class="col-6 col-md-3">
                                                                <label for="status"
                                                                    class="form-label small fw-bold text-muted text-uppercase">Status</label>
                                                                <select class="form-select form-select-sm" id="status"
                                                                    name="status">
                                                                    <option value="all" <%=!filters.status ||
                                                                        filters.status==='all' ? 'selected' : '' %>>All
                                                                        Statuses</option>
                                                                    <option value="submitted"
                                                                        <%=filters.status==='submitted' ? 'selected'
                                                                        : '' %>>Submitted</option>
                                                                    <option value="draft" <%=filters.status==='draft'
                                                                        ? 'selected' : '' %>>Draft</option>
                                                                </select>
                                                            </div>
                                                            <div class="col-6 col-md-3">
                                                                <label for="date_from"
                                                                    class="form-label small fw-bold text-muted text-uppercase">From
                                                                    Date</label>
                                                                <input type="date" class="form-control form-control-sm"
                                                                    id="date_from" name="date_from"
                                                                    value="<%= filters.date_from || '' %>">
                                                            </div>
                                                            <div class="col-6 col-md-3">
                                                                <label for="date_to"
                                                                    class="form-label small fw-bold text-muted text-uppercase">To
                                                                    Date</label>
                                                                <input type="date" class="form-control form-control-sm"
                                                                    id="date_to" name="date_to"
                                                                    value="<%= filters.date_to || '' %>">
                                                            </div>
                                                            <div class="col-12 text-end">
                                                                <a href="/admin/assessments"
                                                                    class="text-decoration-none small text-danger">
                                                                    <i class="bi bi-x-circle me-1"></i>Clear All Filters
                                                                </a>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </form>
                                        </div>
                                    </div>

                                    <!-- Assessments Table -->
                                    <div class="card border-0 shadow-sm">
                                        <div
                                            class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                                            <h5 class="card-title mb-0">Assessments List</h5>
                                            <span class="badge bg-light text-dark border">Total:
                                                <%= assessments.length %>
                                            </span>
                                        </div>
                                        <div class="table-responsive">
                                            <table class="table table-hover align-middle mb-0">
                                                <thead class="bg-light">
                                                    <tr>
                                                        <th class="ps-4 py-3" style="min-width: 200px;">Patient
                                                            Details
                                                        </th>
                                                        <th style="min-width: 120px;">Type</th>
                                                        <th style="min-width: 150px;">Assessment
                                                            Date</th>
                                                        <th style="min-width: 100px;">Status
                                                        </th>
                                                        <th style="min-width: 100px;">Signature
                                                        </th>
                                                        <th style="width: 30%;">Preview</th>
                                                        <th style="min-width: 150px;">Assessed
                                                            By</th>
                                                        <th class="text-end pe-4" style="min-width: 120px;">Actions
                                                        </th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <% if (assessments && assessments.length> 0)
                                                        { %>
                                                        <% assessments.forEach(assessment=> { %>
                                                            <tr>
                                                                <td class="ps-4">
                                                                    <div class="fw-bold text-dark">
                                                                        <%= assessment.patient_name %>
                                                                    </div>
                                                                    <div class="small text-muted">
                                                                        <span class="me-2"><i class="bi bi-hash"></i>
                                                                            <%= assessment.medical_number || 'N/A' %>
                                                                        </span>
                                                                        <span><i class="bi bi-calendar-event"></i>
                                                                            Visit
                                                                            #<%= assessment.visit_id %></span>
                                                                    </div>
                                                                </td>
                                                                <td>
                                                                    <% if (assessment.assessment_type==='nursing' ) { %>
                                                                        <span
                                                                            class="badge bg-soft-primary text-primary rounded-pill">
                                                                            <i
                                                                                class="fas fa-user-nurse me-1"></i>Nursing
                                                                        </span>
                                                                        <% } else { %>
                                                                            <span
                                                                                class="badge bg-soft-info text-info rounded-pill">
                                                                                <i
                                                                                    class="fas fa-x-ray me-1"></i>Radiology
                                                                            </span>
                                                                            <% } %>
                                                                </td>
                                                                <td>
                                                                    <div class="fw-medium">
                                                                        <%= new
                                                                            Date(assessment.assessment_date).toLocaleDateString()
                                                                            %>
                                                                    </div>
                                                                    <div class="small text-muted">
                                                                        <%= new
                                                                            Date(assessment.assessment_date).toLocaleTimeString([],
                                                                            {hour: '2-digit' , minute:'2-digit'}) %>
                                                                    </div>
                                                                </td>
                                                                <td>
                                                                    <% if (assessment.submission_status==='submitted' )
                                                                        { %>
                                                                        <span
                                                                            class="badge bg-soft-success text-success">Submitted</span>
                                                                        <% } else { %>
                                                                            <span
                                                                                class="badge bg-soft-warning text-warning">Draft</span>
                                                                            <% } %>
                                                                </td>
                                                                <td>
                                                                    <% if (assessment.nurse_signature ||
                                                                        assessment.physician_signature) { %>
                                                                        <i class="bi bi-pen-fill text-success fs-5"
                                                                            title="Signed"></i>
                                                                        <% } else { %>
                                                                            <i class="bi bi-pen text-muted fs-5 opacity-50"
                                                                                title="Unsigned"></i>
                                                                            <% } %>
                                                                </td>
                                                                <td>
                                                                    <div class="text-truncate text-muted small"
                                                                        style="max-width: 250px;">
                                                                        <% if (assessment.assessment_type==='nursing' )
                                                                            { %>
                                                                            <%= assessment.chief_complaint
                                                                                || 'No chief complaint recorded' %>
                                                                                <% } else { %>
                                                                                    <%= assessment.diagnosis
                                                                                        || 'No diagnosis recorded' %>
                                                                                        <% } %>
                                                                    </div>
                                                                </td>
                                                                <td>
                                                                    <div class="d-flex align-items-center">
                                                                        <div class="avatar-circle bg-light text-secondary small me-2"
                                                                            style="width: 24px; height: 24px; font-size: 10px;">
                                                                            <%= (assessment.assessed_by_name || 'U'
                                                                                ).charAt(0).toUpperCase() %>
                                                                        </div>
                                                                        <span class="small">
                                                                            <%= assessment.assessed_by_name || 'Unknown'
                                                                                %>
                                                                        </span>
                                                                    </div>
                                                                </td>
                                                                <td class="text-end pe-4">
                                                                    <div class="btn-group">
                                                                        <a href="/admin/assessments/<%= assessment.id %>?type=<%= assessment.assessment_type %>"
                                                                            class="btn btn-sm btn-light border"
                                                                            title="View Details">
                                                                            <i class="bi bi-eye me-1"></i>View
                                                                        </a>
                                                                        <button type="button"
                                                                            class="btn btn-sm btn-light border text-danger"
                                                                            title="Delete Assessment"
                                                                            onclick="confirmDeleteAssessment('<%= assessment.id %>', '<%= assessment.assessment_type %>', '<%= assessment.patient_name %>')">
                                                                            <i class="bi bi-trash me-1"></i>Delete
                                                                        </button>
                                                                    </div>
                                                                </td>
                                                            </tr>
                                                            <% }); %>
                                                                <% } else { %>
                                                                    <tr>
                                                                        <td colspan="8" class="text-center py-5">
                                                                            <div class="text-muted mb-2">
                                                                                <i
                                                                                    class="bi bi-clipboard-x display-4"></i>
                                                                            </div>
                                                                            <h5 class="text-muted">
                                                                                No Assessments
                                                                                Found
                                                                            </h5>
                                                                            <p class="text-muted small mb-0">
                                                                                Try
                                                                                adjusting your
                                                                                filters</p>
                                                                        </td>
                                                                    </tr>
                                                                    <% } %>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>

                        </div>
                    </div>
            </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>

    <!-- Delete Assessment Confirmation Modal -->
    <div class="modal fade" id="deleteAssessmentModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>Delete
                        Assessment
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body p-4">
                    <p class="mb-3">Are you sure you want to delete this <strong id="assessmentTypeText"></strong>
                        assessment for <strong id="assessmentPatientName"></strong>?</p>
                    <div class="alert alert-soft-danger text-danger border-danger small mb-0">
                        <i class="bi bi-exclamation-circle me-1"></i> This action cannot
                        be undone and will remove all
                        associated medical records.
                    </div>
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-link text-muted text-decoration-none"
                        data-bs-dismiss="modal">Cancel</button>
                    <form id="deleteAssessmentForm" method="POST" class="d-inline">
                        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                        <button type="submit" class="btn btn-danger px-4">Delete
                            Permanently</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        function confirmDeleteAssessment(assessmentId, assessmentType, patientName) {
            document.getElementById('assessmentTypeText').textContent = assessmentType.charAt(0).toUpperCase() + assessmentType.slice(1);
            document.getElementById('assessmentPatientName').textContent = patientName;
            document.getElementById('deleteAssessmentForm').action = `/admin/assessments/${assessmentId}/delete?type=${assessmentType}`;

            const modal = new bootstrap.Modal(document.getElementById('deleteAssessmentModal'));
            modal.show();
        }
    </script>
</body>

</html>