<!DOCTYPE html>
<html lang="en">

<head>
    <%- include('partials/head', { title: 'Visit Details' }) %>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
</head>

<body class="admin-compact">
    <div class="d-flex vh-100 bg-light overflow-hidden">
        <!-- Sidebar -->
        <%- include('partials/admin-sidebar', { currentPage: 'visits' }) %>

            <!-- Main Content -->
            <div class="flex-grow-1 d-flex flex-column h-100 overflow-hidden">
                <!-- Header -->
                <%- include('partials/admin-header', { title: 'Visit Details' }) %>

                    <!-- Scrollable Content -->
                    <main class="flex-grow-1 overflow-auto p-4">

                        <% if (typeof notification !=='undefined' && notification) { %>
                            <div class="alert alert-<%= notification.type === 'error' ? 'danger' : 'success' %> alert-dismissible fade show mb-4 border-0 shadow-sm"
                                role="alert">
                                <% if(notification.type==='success' ) { %><i class="bi bi-check-circle-fill me-2"></i>
                                    <% } %>
                                        <% if(notification.type==='error' ) { %><i
                                                class="bi bi-exclamation-triangle-fill me-2"></i>
                                            <% } %>
                                                <%= notification.message %>
                                                    <button type="button" class="btn-close" data-bs-dismiss="alert"
                                                        aria-label="Close"></button>
                            </div>
                            <% } %>

                                <!-- Page Header & Actions -->
                                <div class="d-flex justify-content-between align-items-center mb-4">
                                    <div>
                                        <nav aria-label="breadcrumb">
                                            <ol class="breadcrumb mb-1">
                                                <li class="breadcrumb-item"><a href="/admin/visits"
                                                        class="text-decoration-none text-muted">Visits</a></li>
                                                <li class="breadcrumb-item active" aria-current="page">Details</li>
                                            </ol>
                                        </nav>
                                        <h4 class="fw-bold mb-0">Visit #<%= visit.visit_id.substring(0, 8) %>...</h4>
                                    </div>
                                    <div class="d-flex gap-2">
                                        <a href="/admin/visits" class="btn btn-light border">
                                            <i class="bi bi-arrow-left me-2"></i>Back
                                        </a>
                                        <a href="/admin/visits/<%= visit.visit_id %>/print-compact" target="_blank"
                                            class="btn btn-outline-primary">
                                            <i class="bi bi-printer me-2"></i>Print Report
                                        </a>
                                    </div>
                                </div>

                                <div class="row g-4">
                                    <!-- Left Column: Patient & Visit Info -->
                                    <div class="col-lg-4">
                                        <!-- Patient Info Card -->
                                        <div class="card border-0 shadow-sm rounded-3 mb-4">
                                            <div class="card-header bg-white border-bottom-0 py-3">
                                                <h5 class="mb-0 fw-bold"><i
                                                        class="bi bi-person me-2 text-primary"></i>Patient Info</h5>
                                            </div>
                                            <div class="card-body pt-0">
                                                <div class="d-flex align-items-center mb-3">
                                                    <div class="avatar-circle bg-primary-subtle text-primary rounded-circle d-flex align-items-center justify-content-center me-3"
                                                        style="width: 48px; height: 48px; font-size: 1.25rem; font-weight: bold;">
                                                        <%= (visit.full_name || 'U' ).charAt(0).toUpperCase() %>
                                                    </div>
                                                    <div>
                                                        <h6 class="mb-0 fw-bold">
                                                            <%= visit.full_name %>
                                                        </h6>
                                                        <small class="text-muted">
                                                            <%= visit.medical_number || 'No Med ID' %>
                                                        </small>
                                                    </div>
                                                </div>
                                                <hr class="text-muted opacity-25">
                                                <dl class="row g-0 mb-0">
                                                    <dt class="col-sm-4 text-muted small fw-normal">SSN</dt>
                                                    <dd class="col-sm-8 small fw-medium">
                                                        <%= visit.patient_ssn || '-' %>
                                                    </dd>

                                                    <dt class="col-sm-4 text-muted small fw-normal">DOB</dt>
                                                    <dd class="col-sm-8 small fw-medium">
                                                        <%= new Date(visit.date_of_birth).toLocaleDateString() %>
                                                    </dd>

                                                    <dt class="col-sm-4 text-muted small fw-normal">Gender</dt>
                                                    <dd class="col-sm-8 small fw-medium">
                                                        <%= visit.gender || '-' %>
                                                    </dd>

                                                    <dt class="col-sm-4 text-muted small fw-normal">Phone</dt>
                                                    <dd class="col-sm-8 small fw-medium">
                                                        <%= visit.mobile_number || visit.phone_number || '-' %>
                                                    </dd>

                                                    <dt class="col-sm-4 text-muted small fw-normal">Address</dt>
                                                    <dd class="col-sm-8 small fw-medium text-truncate"
                                                        title="<%= visit.address %>">
                                                        <%= visit.address || '-' %>
                                                    </dd>
                                                </dl>
                                            </div>
                                        </div>

                                        <!-- Visit Details Card -->
                                        <div class="card border-0 shadow-sm rounded-3">
                                            <div class="card-header bg-white border-bottom-0 py-3">
                                                <h5 class="mb-0 fw-bold"><i
                                                        class="bi bi-info-circle me-2 text-primary"></i>Visit Info</h5>
                                            </div>
                                            <div class="card-body pt-0">
                                                <dl class="row g-0 mb-0">
                                                    <dt class="col-sm-5 text-muted small fw-normal">Status</dt>
                                                    <dd class="col-sm-7 small">
                                                        <% if (visit.visit_status==='completed' ) { %>
                                                            <span
                                                                class="badge bg-success-subtle text-success border border-success-subtle rounded-pill">Completed</span>
                                                            <% } else if (visit.visit_status==='in-progress' ) { %>
                                                                <span
                                                                    class="badge bg-info-subtle text-info border border-info-subtle rounded-pill">In
                                                                    Progress</span>
                                                                <% } else if (visit.visit_status==='cancelled' ) { %>
                                                                    <span
                                                                        class="badge bg-danger-subtle text-danger border border-danger-subtle rounded-pill">Cancelled</span>
                                                                    <% } else { %>
                                                                        <span
                                                                            class="badge bg-warning-subtle text-warning border border-warning-subtle rounded-pill">Pending</span>
                                                                        <% } %>
                                                    </dd>

                                                    <dt class="col-sm-5 text-muted small fw-normal">Date</dt>
                                                    <dd class="col-sm-7 small fw-medium">
                                                        <%= new Date(visit.visit_date).toLocaleDateString() %>
                                                    </dd>

                                                    <dt class="col-sm-5 text-muted small fw-normal">Time</dt>
                                                    <dd class="col-sm-7 small fw-medium">
                                                        <%= new Date(visit.visit_date).toLocaleTimeString() %>
                                                    </dd>

                                                    <dt class="col-sm-5 text-muted small fw-normal">Department</dt>
                                                    <dd class="col-sm-7 small fw-medium">
                                                        <%= visit.department || '-' %>
                                                    </dd>

                                                    <dt class="col-sm-5 text-muted small fw-normal">Type</dt>
                                                    <dd class="col-sm-7 small fw-medium">
                                                        <%= visit.visit_type || 'Walk-in' %>
                                                    </dd>
                                                </dl>
                                                <% if (visit.primary_diagnosis) { %>
                                                    <div class="mt-3 p-2 bg-light rounded text-center">
                                                        <small class="text-muted d-block text-uppercase"
                                                            style="font-size: 0.7rem; font-weight: 600;">Primary
                                                            Diagnosis</small>
                                                        <span class="fw-medium text-dark">
                                                            <%= visit.primary_diagnosis %>
                                                        </span>
                                                    </div>
                                                    <% } %>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Right Column: Assessments -->
                                    <div class="col-lg-8">

                                        <% if (!nursingAssessment && !radiologyAssessment) { %>
                                            <div class="card border-0 shadow-sm rounded-3 py-5 text-center">
                                                <div class="card-body">
                                                    <div class="mb-3 text-muted opacity-25">
                                                        <i class="bi bi-file-earmark-medical display-1"></i>
                                                    </div>
                                                    <h5 class="fw-bold">No Assessments Recorded</h5>
                                                    <p class="text-muted">There are no nursing or radiology assessments
                                                        for this visit.</p>
                                                </div>
                                            </div>
                                            <% } %>

                                                <!-- Nursing Assessment -->
                                                <% if (nursingAssessment) { %>
                                                    <div class="card border-0 shadow-sm rounded-3 mb-4">
                                                        <div
                                                            class="card-header bg-white py-3 border-bottom d-flex justify-content-between align-items-center">
                                                            <h5 class="mb-0 fw-bold text-primary"><i
                                                                    class="bi bi-activity me-2"></i>Nursing Assessment
                                                            </h5>
                                                            <small class="text-muted">By <%=
                                                                    nursingAssessment.assessed_by_name || 'Nurse' %> on
                                                                    <%= new
                                                                        Date(nursingAssessment.assessed_at).toLocaleDateString()
                                                                        %></small>
                                                        </div>
                                                        <div class="card-body">
                                                            <!-- Vital Signs Grid -->
                                                            <div
                                                                class="row row-cols-2 row-cols-md-3 row-cols-lg-6 g-2 mb-4">
                                                                <div class="col">
                                                                    <div
                                                                        class="p-2 border rounded text-center bg-light h-100">
                                                                        <small class="d-block text-muted text-uppercase"
                                                                            style="font-size: 0.65rem;">Temp</small>
                                                                        <div class="fw-bold text-dark">
                                                                            <%= nursingAssessment.temperature_celsius
                                                                                || '-' %> <span
                                                                                    class="small text-muted fw-normal">Â°C</span>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <div class="col">
                                                                    <div
                                                                        class="p-2 border rounded text-center bg-light h-100">
                                                                        <small class="d-block text-muted text-uppercase"
                                                                            style="font-size: 0.65rem;">Pulse</small>
                                                                        <div class="fw-bold text-dark">
                                                                            <%= nursingAssessment.pulse_bpm || '-' %>
                                                                                <span
                                                                                    class="small text-muted fw-normal">bpm</span>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <div class="col">
                                                                    <div
                                                                        class="p-2 border rounded text-center bg-light h-100">
                                                                        <small class="d-block text-muted text-uppercase"
                                                                            style="font-size: 0.65rem;">BP</small>
                                                                        <div class="fw-bold text-dark">
                                                                            <%= nursingAssessment.blood_pressure_systolic
                                                                                || '-' %>/<%=
                                                                                    nursingAssessment.blood_pressure_diastolic
                                                                                    || '-' %>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <div class="col">
                                                                    <div
                                                                        class="p-2 border rounded text-center bg-light h-100">
                                                                        <small class="d-block text-muted text-uppercase"
                                                                            style="font-size: 0.65rem;">Resp</small>
                                                                        <div class="fw-bold text-dark">
                                                                            <%= nursingAssessment.respiratory_rate_per_min
                                                                                || '-' %> <span
                                                                                    class="small text-muted fw-normal">/min</span>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <div class="col">
                                                                    <div
                                                                        class="p-2 border rounded text-center bg-light h-100">
                                                                        <small class="d-block text-muted text-uppercase"
                                                                            style="font-size: 0.65rem;">SpO2</small>
                                                                        <div class="fw-bold text-dark">
                                                                            <%= nursingAssessment.oxygen_saturation_percent
                                                                                || '-' %> <span
                                                                                    class="small text-muted fw-normal">%</span>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <div class="col">
                                                                    <div
                                                                        class="p-2 border rounded text-center bg-light h-100">
                                                                        <small class="d-block text-muted text-uppercase"
                                                                            style="font-size: 0.65rem;">Sugar</small>
                                                                        <div class="fw-bold text-dark">
                                                                            <%= nursingAssessment.blood_sugar_mg_dl
                                                                                || '-' %> <span
                                                                                    class="small text-muted fw-normal">mg/dL</span>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>

                                                            <div class="row g-4 mb-3">
                                                                <div class="col-md-6">
                                                                    <h6
                                                                        class="text-uppercase text-secondary small fw-bold mb-3 border-bottom pb-2">
                                                                        Physical Check</h6>
                                                                    <dl class="row mb-0">
                                                                        <dt class="col-6 text-muted small fw-normal">
                                                                            General Cond.</dt>
                                                                        <dd class="col-6 small fw-medium">
                                                                            <%= nursingAssessment.general_condition
                                                                                || '-' %>
                                                                        </dd>
                                                                        <dt class="col-6 text-muted small fw-normal">
                                                                            Consciousness</dt>
                                                                        <dd class="col-6 small fw-medium">
                                                                            <%= nursingAssessment.consciousness_level
                                                                                || '-' %>
                                                                        </dd>
                                                                        <dt class="col-6 text-muted small fw-normal">
                                                                            Skin</dt>
                                                                        <dd class="col-6 small fw-medium">
                                                                            <%= nursingAssessment.skin_condition || '-'
                                                                                %>
                                                                        </dd>
                                                                        <dt class="col-6 text-muted small fw-normal">
                                                                            Mobility</dt>
                                                                        <dd class="col-6 small fw-medium">
                                                                            <%= nursingAssessment.mobility_status || '-'
                                                                                %>
                                                                        </dd>
                                                                    </dl>
                                                                </div>
                                                                <div class="col-md-6">
                                                                    <h6
                                                                        class="text-uppercase text-secondary small fw-bold mb-3 border-bottom pb-2">
                                                                        History & Info</h6>
                                                                    <dl class="row mb-0">
                                                                        <dt class="col-6 text-muted small fw-normal">
                                                                            Smoker</dt>
                                                                        <dd class="col-6 small fw-medium">
                                                                            <%= nursingAssessment.is_smoker ? 'Yes'
                                                                                : 'No' %>
                                                                        </dd>
                                                                        <dt class="col-6 text-muted small fw-normal">
                                                                            Allergies</dt>
                                                                        <dd class="col-6 small fw-medium">
                                                                            <%= nursingAssessment.has_allergies ? 'Yes'
                                                                                : 'No' %>
                                                                        </dd>
                                                                        <dt class="col-6 text-muted small fw-normal">
                                                                            Diet Type</dt>
                                                                        <dd class="col-6 small fw-medium">
                                                                            <%= nursingAssessment.diet_type || '-' %>
                                                                        </dd>
                                                                    </dl>
                                                                </div>
                                                            </div>

                                                            <% if (nursingAssessment.chief_complaint) { %>
                                                                <div class="mb-3">
                                                                    <h6
                                                                        class="text-uppercase text-secondary small fw-bold">
                                                                        Chief Complaint</h6>
                                                                    <p class="small text-dark mb-0">
                                                                        <%= nursingAssessment.chief_complaint %>
                                                                    </p>
                                                                </div>
                                                                <% } %>
                                                        </div>
                                                    </div>
                                                    <% } %>

                                                        <!-- Radiology Assessment -->
                                                        <% if (radiologyAssessment) { %>
                                                            <div class="card border-0 shadow-sm rounded-3">
                                                                <div
                                                                    class="card-header bg-white py-3 border-bottom d-flex justify-content-between align-items-center">
                                                                    <h5 class="mb-0 fw-bold text-success"><i
                                                                            class="bi bi-radioactive me-2"></i>Radiology
                                                                        Report</h5>
                                                                    <small class="text-muted">By <%=
                                                                            radiologyAssessment.assessed_by_name
                                                                            || 'Radiologist' %> on <%= new
                                                                                Date(radiologyAssessment.assessed_at).toLocaleDateString()
                                                                                %></small>
                                                                </div>
                                                                <div class="card-body">
                                                                    <div class="row g-3 mb-4">
                                                                        <div class="col-md-4">
                                                                            <div class="p-3 bg-light rounded h-100">
                                                                                <small
                                                                                    class="d-block text-muted text-uppercase mb-1"
                                                                                    style="font-size: 0.7rem;">Modality</small>
                                                                                <div class="fw-bold">
                                                                                    <%= radiologyAssessment.modality
                                                                                        || '-' %>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                        <div class="col-md-4">
                                                                            <div class="p-3 bg-light rounded h-100">
                                                                                <small
                                                                                    class="d-block text-muted text-uppercase mb-1"
                                                                                    style="font-size: 0.7rem;">Study
                                                                                    Reason</small>
                                                                                <div class="fw-bold">
                                                                                    <%= radiologyAssessment.reason_for_study
                                                                                        || '-' %>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                        <div class="col-md-4">
                                                                            <div class="p-3 bg-light rounded h-100">
                                                                                <small
                                                                                    class="d-block text-muted text-uppercase mb-1"
                                                                                    style="font-size: 0.7rem;">Diagnosis</small>
                                                                                <div class="fw-bold">
                                                                                    <%= radiologyAssessment.diagnosis
                                                                                        || '-' %>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    </div>

                                                                    <% if (radiologyAssessment.findings) { %>
                                                                        <div class="mb-4">
                                                                            <h6
                                                                                class="text-uppercase text-secondary small fw-bold mb-2">
                                                                                Findings</h6>
                                                                            <div class="p-3 border rounded bg-white small text-dark"
                                                                                style="white-space: pre-wrap;">
                                                                                <%= radiologyAssessment.findings %>
                                                                            </div>
                                                                        </div>
                                                                        <% } %>

                                                                            <% if (radiologyAssessment.impression) { %>
                                                                                <div class="mb-4">
                                                                                    <h6
                                                                                        class="text-uppercase text-secondary small fw-bold mb-2">
                                                                                        Impression</h6>
                                                                                    <div class="p-3 border rounded bg-white small text-dark"
                                                                                        style="white-space: pre-wrap;">
                                                                                        <%= radiologyAssessment.impression
                                                                                            %>
                                                                                    </div>
                                                                                </div>
                                                                                <% } %>

                                                                                    <% if
                                                                                        (radiologyAssessment.recommendations)
                                                                                        { %>
                                                                                        <div class="mb-0">
                                                                                            <h6
                                                                                                class="text-uppercase text-secondary small fw-bold mb-2">
                                                                                                Recommendations</h6>
                                                                                            <div class="p-3 border rounded bg-warning-subtle text-dark border-warning small"
                                                                                                style="white-space: pre-wrap;">
                                                                                                <%= radiologyAssessment.recommendations
                                                                                                    %>
                                                                                            </div>
                                                                                        </div>
                                                                                        <% } %>
                                                                </div>
                                                            </div>
                                                            <% } %>

                                    </div>
                                </div>

                    </main>
            </div>
    </div>
    <%- include('partials/scripts') %>
</body>

</html>